<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; margin: 2rem; color: #1f2933; }
    h1 { color: #2563eb; }
    h2 { margin-top: 2rem; }
    h3 { margin-top: 1.25rem; color: #1d4ed8; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1.5rem; }
    th, td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; vertical-align: top; }
    th { background: #eff6ff; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .degraded { color: #d97706; font-weight: 600; }
    .score-main { font-weight: 600; }
    .score-sub { font-size: 0.85rem; color: #4b5563; margin-top: 0.2rem; }
    .badge { display: inline-block; margin-left: 0.3rem; padding: 0.12rem 0.45rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; }
    .badge-fallback { background: #fef3c7; color: #b45309; }
    .delta-up { color: #047857; }
    .delta-down { color: #b91c1c; }
    .source-note { font-size: 0.75rem; color: #6b7280; margin-top: 0.2rem; }
    .weights-list { list-style: none; padding-left: 0; margin-top: -0.5rem; }
    .weights-list li { margin: 0.4rem 0; }
    .status-table th { background: #f1f5f9; }
    .status-ok { color: #047857; font-weight: 600; }
    .status-fail { color: #b91c1c; font-weight: 600; }
    .event-empty { color: #6b7280; }
    .appendix-list { padding-left: 1.2rem; }
    .appendix-list li { margin-bottom: 0.4rem; }
  </style>
</head>
<body>
  <h1>{{ title }}</h1>
  <p>日期：{{ date }}</p>
  {% if degraded %}
  <p class="degraded">⚠️ 数据存在缺口，以下结论仅供参考，请谨慎操作。</p>
  {% endif %}
  <section>
    <h2>主题评分</h2>
    <table>
      <thead>
        <tr>
          <th>主题</th>
          <th>总分</th>
          <th>基本面</th>
          <th>估值</th>
          <th>情绪</th>
          <th>资金</th>
          <th>事件</th>
        </tr>
      </thead>
      <tbody>
      {% for theme in themes %}
        {% set detail = theme.breakdown_detail or {} %}
        {% set meta = theme.meta or {} %}
        <tr>
          <td>{{ theme.label }}</td>
          <td>
            <div class="score-main">{{ '%.1f' | format(theme.total) }}</div>
            {% set delta = meta.get('delta') %}
            {% if delta is not none %}
            <div class="score-sub">
              Δ <span class="{{ 'delta-up' if delta >= 0 else 'delta-down' }}">{{ '%+.1f' | format(delta) }}</span>
            </div>
            {% endif %}
            {% set dist_add = meta.get('distance_to_add') %}
            {% set dist_trim = meta.get('distance_to_trim') %}
            {% if dist_add is not none or dist_trim is not none %}
            <div class="score-sub">
              {% if dist_add is not none %}
                ↗ 增持 {{ '%+.1f' | format(dist_add) }}
              {% endif %}
              {% if dist_trim is not none %}
                {% if dist_add is not none %} · {% endif %}
                ↘ 减持 {{ '%+.1f' | format(dist_trim) }}
              {% endif %}
            </div>
            {% endif %}
          </td>
          {% for key in ['fundamental', 'valuation', 'sentiment', 'liquidity', 'event'] %}
            {% set component = detail.get(key, {}) %}
            {% set value = component.get('value', theme.breakdown[key]) %}
            <td>
              <div class="score-main">{{ value | round(1) }}</div>
              {% if component.fallback %}
                <span class="badge badge-fallback" title="{{ component.reason or '数据缺口，使用中性值' }}">∅</span>
              {% endif %}
              {% if component.source %}
                <div class="source-note">{{ component.source }}</div>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% if thresholds %}
      {% set add_th = thresholds.get('action_add') %}
      {% set trim_th = thresholds.get('action_trim') %}
      {% if add_th is not none or trim_th is not none %}
      <p class="score-sub">
        策略阈值：
        {% if add_th is not none %}增持 ≥ {{ add_th }}{% endif %}
        {% if add_th is not none and trim_th is not none %}，{% endif %}
        {% if trim_th is not none %}减持 ≤ {{ trim_th }}{% endif %}
      </p>
      {% endif %}
    {% endif %}
  {% if themes %}
    <h3>指标权重</h3>
    <ul class="weights-list">
      {% for theme in themes %}
        {% set meta = theme.meta or {} %}
        {% set weight_map = meta.get('weights', {}) %}
        {% if weight_map %}
        <li><strong>{{ theme.label }}</strong>：
          {% for key, weight in weight_map.items() %}
            {{ metric_labels.get(key, key) }} {{ '%.0f' | format(weight * 100) }}{% if not loop.last %}%，{% else %}%{% endif %}
          {% endfor %}
        </li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}
  </section>
  {% if theme_details %}
  <section>
    <h2>抓取明细：主题成分与报价</h2>
    {% for theme in themes %}
      {% set detail = theme_details.get(theme.name) if theme_details else None %}
      {% if detail and detail.symbols %}
        <h3>{{ theme.label }}</h3>
        <table>
          <thead>
            <tr>
              <th>代码</th>
              <th>最新价</th>
              <th>日变动</th>
              <th>PE</th>
              <th>PS</th>
              <th>PB</th>
              <th>市值</th>
              <th>来源</th>
            </tr>
          </thead>
          <tbody>
          {% for row in detail.symbols %}
            <tr>
              <td>{{ row.symbol }}</td>
              <td>{% if row.price is not none %}{{ '%.2f' | format(row.price) }}{% else %}—{% endif %}</td>
              <td>{% if row.change_pct is not none %}{{ '%+.2f%%' | format(row.change_pct) }}{% else %}—{% endif %}</td>
              <td>{% if row.pe is not none %}{{ '%.2f' | format(row.pe) }}{% else %}—{% endif %}</td>
              <td>{% if row.ps is not none %}{{ '%.2f' | format(row.ps) }}{% else %}—{% endif %}</td>
              <td>{% if row.pb is not none %}{{ '%.2f' | format(row.pb) }}{% else %}—{% endif %}</td>
              <td>{% if row.market_cap is not none %}{{ '%.0f' | format(row.market_cap) }}{% else %}—{% endif %}</td>
              <td>{{ row.source }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endfor %}
  </section>
  {% endif %}
  <section>
    <h2>建议动作</h2>
    <ul>
    {% for action in actions %}
      <li><strong>{{ action.action }}</strong> {{ action.name }} —— {{ action.reason }}</li>
    {% endfor %}
    </ul>
  </section>
  {% if etl_sources %}
  <section>
    <h2>数据状态</h2>
    <table class="status-table">
      <thead>
        <tr>
          <th>来源</th>
          <th>状态</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
      {% for src in etl_sources %}
        <tr>
          <td>{{ src.name }}</td>
          <td class="{{ 'status-ok' if src.ok else 'status-fail' }}">{{ '正常' if src.ok else '降级' }}</td>
          <td>{{ src.message }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}
  {% if ai_updates %}
  <section>
    <h2>AI / RSS 更新</h2>
    <ul>
    {% for item in ai_updates %}
      <li>{{ item.date }} · {% if item.url %}<a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.title }}</a>{% else %}{{ item.title }}{% endif %}{% if item.source %}（源：{{ item.source }}）{% endif %}</li>
    {% endfor %}
    </ul>
  </section>
  {% endif %}
  {% if news_text %}
  <section>
    <h2>AI 市场资讯（GLM）</h2>
    {% if news_sections %}
      {% for section in news_sections %}
        <article class="ai-market-section">
          <h3>{{ section.label }}{% if section.date %} · {{ section.date }}{% endif %}</h3>
          <pre style="white-space: pre-wrap; margin-top: .5rem;">{{ section.text }}</pre>
        </article>
      {% endfor %}
    {% else %}
      <p class="ai-market-empty">{{ news_text.strip() }}</p>
    {% endif %}
  </section>
  {% endif %}
  <section>
    <h2>未来事件</h2>
    {% if events %}
      <ul>
      {% for event in events %}
        <li>{{ event.date }} · {{ event.title }} · 影响级别：{{ event.impact }}</li>
      {% endfor %}
      </ul>
    {% else %}
      <p class="event-empty">暂无未来事件。</p>
    {% endif %}
  </section>
  {% if sentiment %}
  <section>
    <h2>情绪细项</h2>
    <table>
      <thead>
        <tr>
          <th>指标</th>
          <th>分值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>综合</td>
          <td>{{ sentiment.score | round(1) }}</td>
        </tr>
        {% for key, value in sentiment.items() if key != 'score' %}
        <tr>
          <td>{{ sentiment_labels.get(key, key) }}</td>
          <td>{{ value | round(1) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}
  <section>
    <h2>附录：指标口径与公式</h2>
    <h3>情绪打分</h3>
    <ul class="appendix-list">
      <li>Put/Call：对 CBOE 股票 Put/Call 取对数后，以历史均值及标准差标准化得到 <code>z</code>，再计算 <code>-tanh(z / 2)</code> 并映射为 <code>50 + 50 × (-tanh(z / 2))</code>。</li>
      <li>AAII：将多头减空头的差值标准化得到 <code>z</code>，取 <code>tanh(z / 2)</code> 后映射为 <code>50 + 50 × tanh(z / 2)</code>。</li>
      <li>综合情绪：取两项压缩结果的平均值，范围约 [-1, 1]，最终换算到 0–100 区间。</li>
    </ul>
    <h3>主题评分</h3>
    <p>每个主题包含基本面、估值、情绪、资金、事件五个一级因子，按配置权重求和：<code>total = Σ weight_k × breakdown_k</code>。Magnificent 7 使用市值、PE、ETF 流动等指标；BTC 主题额外纳入基差与资金流。</p>
    <h3>未来事件</h3>
    <p>事件列表汇总 Trading Economics 的 5 日宏观窗口，并结合 AI/RSS 与 arXiv 更新，帮助快速浏览即将发生的潜在催化。</p>
  </section>
  <footer>
    <p>报告自动生成时间：{{ generated_at }}</p>
    {% set market_link = raw_links.get('market') if raw_links else 'raw_market.json' %}
    {% set events_link = raw_links.get('events') if raw_links else 'raw_events.json' %}
    <p>原始产物：
      {% if market_link %}<a href="{{ market_link }}" target="_blank" rel="noopener">{{ market_link }}</a>{% endif %}
      {% if market_link and events_link %} · {% endif %}
      {% if events_link %}<a href="{{ events_link }}" target="_blank" rel="noopener">{{ events_link }}</a>{% endif %}
    </p>
  </footer>
</body>
</html>
